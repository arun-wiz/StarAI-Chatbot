name: Build and Deploy to EKS

on:
  workflow_dispatch:
    inputs:
      demo_mode:
        description: If true, deploys HTTP-only ingress and prints ALB DNS (no Route53/ACM)
        required: false
        type: boolean
        default: true
      langflow_seed_image:
        description: DockerHub image (e.g. username/repo:tag) containing /seed/langflow.db
        required: false
        type: string
      flow_id:
        description: Override FLOW_ID (optional)
        required: false
        type: string
      public_domain:
        description: Public domain for HTTPS ingress (required when demo_mode=false)
        required: false
        type: string
      alb_acm_arn:
        description: ACM certificate ARN for HTTPS ingress (required when demo_mode=false)
        required: false
        type: string

permissions:
  contents: read
  id-token: write
  actions: read
  security-events: write

jobs:
  build_scan_push_deploy:
    runs-on: ubuntu-latest

    env:
      EKS_CLUSTER_NAME: ${{ vars.EKS_CLUSTER_NAME }}
      EKS_REGION: ${{ vars.EKS_REGION }}

      ECR_REGION: ${{ vars.ECR_REGION }}
      ECR_ACCOUNT: ${{ vars.ECR_ACCOUNT }}
      ECR_REPO: ${{ vars.ECR_REPO }}

      PUBLIC_DOMAIN: ${{ vars.PUBLIC_DOMAIN }}
      ALB_ACM_ARN: ${{ vars.ALB_ACM_ARN }}
      FLOW_ID: ${{ vars.FLOW_ID }}

      MONGO_USER: ${{ secrets.MONGO_USER }}
      MONGO_PASS: ${{ secrets.MONGO_PASS }}
      MONGO_HOST: ${{ secrets.MONGO_HOST }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

      WIZ_CLIENT_ID: ${{ secrets.WIZ_CLIENT_ID }}
      WIZ_CLIENT_SECRET: ${{ secrets.WIZ_CLIENT_SECRET }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ vars.ECR_REGION }}

      - name: Ensure ECR repository exists
        run: |
          set -euo pipefail
          aws ecr describe-repositories --repository-names "${ECR_REPO}" --region "${ECR_REGION}" >/dev/null 2>&1 || \
            aws ecr create-repository \
              --repository-name "${ECR_REPO}" \
              --image-scanning-configuration scanOnPush=true \
              --encryption-configuration encryptionType=AES256 \
              --region "${ECR_REGION}" >/dev/null

      - name: Compute image tag
        id: meta
        run: |
          set -euo pipefail
          SHA="$(git rev-parse --short=12 HEAD)"
          TS="$(date -u +%Y%m%d%H%M%S)"
          TAG="${GITHUB_RUN_NUMBER}-${TS}-${SHA}"
          echo "img_tag=${TAG}" >> "$GITHUB_OUTPUT"
          echo "ecr_image=${ECR_ACCOUNT}.dkr.ecr.${ECR_REGION}.amazonaws.com/${ECR_REPO}" >> "$GITHUB_OUTPUT"

      #- name: Trivy repo scan
      #  uses: aquasecurity/trivy-action@0.22.0
      #  with:
      #   scan-type: fs
      #    scan-ref: .
      #    format: table
      #    exit-code: '0'
      #    ignore-unfixed: true

      - name: Download Wiz CLI
        run: |
          curl -o wizcli https://downloads.wiz.io/v1/wizcli/latest/wizcli-linux-amd64 && chmod +x wizcli
          ./wizcli version


      - name: Wiz CLI code scans (dir + iac + sensitive data)
        run: |
          set -euo pipefail
          mkdir -p wiz-reports

          ./wizcli dir scan --path . --policies=arun-vulnerabilities-policy,arun-secrets-policy,arun-sast-policy --tags github_action_run_id=${{ github.run_id }},project=arun-demo --stdout human --sarif-output-file wiz-reports/dir-scan-results.sarif || true
          ./wizcli iac scan --path . --types Kubernetes,GitHubActions,Terraform,Dockerfile --policies=arun-iac-policy --tags github_action_run_id=${{ github.run_id }},project=arun-demo --stdout human --sarif-output-file wiz-reports/iac-scan-results.sarif || true
          ./wizcli dir scan --path . --sensitive-data --policies=arun-sensitive-data-policy --tags github_action_run_id=${{ github.run_id }},project=arun-demo --stdout human --sarif-output-file wiz-reports/sensitive-data-scan-results.sarif || true
        continue-on-error: true

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push image to ECR
        id: build_gateway
        uses: docker/build-push-action@v6
        with:
          context: .
          file: app/Dockerfile
          push: true
          tags: |
            ${{ steps.meta.outputs.ecr_image }}:latest
            ${{ steps.meta.outputs.ecr_image }}:${{ steps.meta.outputs.img_tag }}

      - name: Wiz CLI docker scan + tag (gateway)
        run: |
          set -euo pipefail

          mkdir -p wiz-reports

          gateway_image="${{ steps.meta.outputs.ecr_image }}:${{ steps.meta.outputs.img_tag }}"
          langflow_image="langflowai/langflow:1.2.0"
          echo "[INFO] Pulling gateway image locally for docker-based scanning: ${gateway_image}"
          docker pull "${gateway_image}" || true

          echo "[INFO] Wiz docker scan (gateway): ${gateway_image}"
          ./wizcli docker scan --image "${gateway_image}" --dockerfile app/Dockerfile --policies=arun-vulnerabilities-policy --tags github_action_run_id=${{ github.run_id }},project=arun-demo --stdout human --sarif-output-file wiz-reports/docker-scan-gateway.sarif || true

          echo "[INFO] Wiz docker tag (gateway): ${gateway_image} digest=${{ steps.build_gateway.outputs.digest }}"
          ./wizcli docker tag --image "${gateway_image}" --digest "${{ steps.build_gateway.outputs.digest }}" || true

          echo "[INFO] Pulling langflow image locally for docker-based scanning: ${langflow_image}"
          docker pull "${langflow_image}" || true

          echo "[INFO] Wiz docker scan (langflow): ${langflow_image}"
          ./wizcli docker scan --image "${langflow_image}" --policies=arun-vulnerabilities-policy --tags github_action_run_id=${{ github.run_id }},project=arun-demo --stdout human --sarif-output-file wiz-reports/docker-scan-langflow.sarif || true

          langflow_repodiagest="$(docker inspect --format='{{index .RepoDigests 0}}' "${langflow_image}" 2>/dev/null || true)"
          langflow_digest="${langflow_repodiagest##*@}"
          if [[ -n "${langflow_digest}" ]]; then
            echo "[INFO] Wiz docker tag (langflow): ${langflow_image} digest=${langflow_digest}"
            ./wizcli docker tag --image "${langflow_image}" --digest "${langflow_digest}" || true
          else
            echo "[WARN] Could not determine langflow image digest (RepoDigests empty); skipping wizcli docker tag" >&2
          fi

      # - name: Trivy image scan (advisory)
      #  uses: aquasecurity/trivy-action@0.22.0
      #  with:
      #    image-ref: ${{ steps.meta.outputs.ecr_image }}:${{ steps.meta.outputs.img_tag }}
      #    format: table
      #    exit-code: '0'
      #    ignore-unfixed: true

      - name: Wiz CLI scan images deployed to EKS
        run: |
          set -euo pipefail

          mkdir -p wiz-reports

          gateway_image="${{ steps.meta.outputs.ecr_image }}:${{ steps.meta.outputs.img_tag }}"
          langflow_image="langflowai/langflow:1.2.0"

          echo "[INFO] Wiz scanning gateway image: ${gateway_image}"
          docker pull "${gateway_image}" || true
          ./wizcli scan container-image "${gateway_image}" --policies=arun-vulnerabilities-policy --tags github_action_run_id=${{ github.run_id }},project=arun-demo --stdout human --sarif-output-file wiz-reports/image-scan-gateway.sarif || true

          echo "[INFO] Wiz scanning langflow image: ${langflow_image}"
          docker pull "${langflow_image}" || true
          ./wizcli scan container-image "${langflow_image}" --policies=arun-vulnerabilities-policy --tags github_action_run_id=${{ github.run_id }},project=arun-demo --stdout human --sarif-output-file wiz-reports/image-scan-langflow.sarif || true

          if [[ -n "${{ inputs.langflow_seed_image }}" ]]; then
            seed_image_raw="${{ inputs.langflow_seed_image }}"
            if [[ "${seed_image_raw}" == *":"* ]]; then
              seed_image="docker.io/${seed_image_raw}"
            else
              seed_image="docker.io/${seed_image_raw}:latest"
            fi
            echo "[INFO] Wiz scanning langflow seed image: ${seed_image}"
            docker pull "${seed_image}" || true
            ./wizcli scan container-image "${seed_image}" --policies=arun-vulnerabilities-policy --tags github_action_run_id=${{ github.run_id }},project=arun-demo --stdout human --sarif-output-file wiz-reports/image-scan-seed.sarif || true
          fi

      - name: Upload Wiz SARIF reports
        if: ${{ always() && hashFiles('wiz-reports/*.sarif') != '' }}
        uses: ./.github/actions/upload-wiz-sarif

      - name: Prepare EKS config
        uses: ./.github/actions/prepare-eks-config
        with:
          kubectl_version: v1.29.0
          demo_mode: ${{ inputs.demo_mode }}
          public_domain: ${{ inputs.public_domain }}
          alb_acm_arn: ${{ inputs.alb_acm_arn }}

      - name: Deploy manifests to EKS
        env:
          ECR_IMAGE: ${{ steps.meta.outputs.ecr_image }}:latest
          ECR_IMAGE_TAGGED: ${{ steps.meta.outputs.ecr_image }}:${{ steps.meta.outputs.img_tag }}
          LANGFLOW_SEED_IMAGE: ${{ inputs.langflow_seed_image }}
          FLOW_ID: ${{ inputs.flow_id || vars.FLOW_ID }}
          PUBLIC_DOMAIN: ${{ inputs.public_domain || vars.PUBLIC_DOMAIN }}
          ALB_ACM_ARN: ${{ inputs.alb_acm_arn || vars.ALB_ACM_ARN }}
          DEMO_MODE: ${{ inputs.demo_mode }}
        run: |
          set -euo pipefail
          chmod +x ci/deploy.sh
          ./ci/deploy.sh
